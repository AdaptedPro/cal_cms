<%= link_to("<< Browse Locations", {:action => 'list'}, :class => 'action_link') %>	

<style type="text/css">
#map-canvas {width: 100%; height: 300px;}
</style>

<br class="clr" />
<div class="location new">
	
	<%= form_for(:location, :url => {:action => 'create'}) do |f| %>
		
		<h2>Create Location</h2>

		<aside><div id="map-canvas"></div></aside>

		<table summary="Location detail view" class="collect-table">
			<tr>
				<th>Address 1:</th>
				<td><%= f.text_field(:location_address_1, :placeholder => 'Address 1') %></td>
			</tr>	
			<tr>
				<th>Address 2:</th>
				<td><%= f.text_field(:location_address_2, :placeholder => 'Address 2') %></td>
			</tr>
			<tr>
				<th>City:</th>
				<td><%= f.text_field(:location_city,:placeholder => 'City') %></td>
			</tr>			
			<tr>
				<th>State:</th>
				<td><%= f.text_field(:location_state, :placeholder => 'State') %></td>
			</tr>			
			<tr>
				<th>Zip:</th>
				<td><%= f.text_field(:location_zip, :placeholder => 'Zip') %></td>
			</tr>						
			<tr>
				<th>Country:</th>
				<td><%= f.text_field(:location_country, :placeholder => 'Country') %></td>
			</tr>			
			<tr>
				<th>Abbreviation:</th>
				<td><%= f.text_field(:location_abbr,:placeholder => 'Abbreviation') %></td>
			</tr>			
			<tr>
				<th>Latitude:</th>
				<td><%= f.text_field(:location_lat,:placeholder => 'Latitude') %></td>
			</tr>	
			<tr>
				<th>Longitude:</th>
				<td><%= f.text_field(:location_lng,:placeholder => 'Longitude') %></td>
			</tr>							
		</table>
		<br />
		<div class="form-buttons">
			<%= submit_tag("Create Location") %>
		</div>	
	
	<% end %>
</div>	

<script type="text/javascript">
function initialize() {
	var mapOptions = {
	  zoom: 8,
	  disableDefaultUI: true,      
	  mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);

	 if(navigator.geolocation) {
	    navigator.geolocation.getCurrentPosition(function(position) {
	      var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

			/*
			var infowindow = new google.maps.InfoWindow({
			map: map,
			position: pos,
			content: 'Location found using HTML5.'
			});
			*/

	      	map.setCenter(pos);

			var markers = [];
			var iterator = 0;
			var neighborhoods = [
				<% @locals.each do |location| %>
				new google.maps.LatLng(<%= location.location_lat %>, <%= location.location_lng %>),
				<% end %>    
			];

			drop();
			function drop() {
				for (var i = 0; i < neighborhoods.length; i++) {
				  //setTimeout(function() {
				    addMarker();
				  //}, i * 300);
				}
			}

			function addMarker() {
				markers.push(new google.maps.Marker({
				  position: neighborhoods[iterator],
				  map: map,
				  draggable: false
				  //animation: google.maps.Animation.BOUNCE
				}));
				iterator++;
			} 

	    }, function() {
	      handleNoGeolocation(true);
	    });
	  } else {		  	
	    // Browser doesn't support Geolocation
	    handleNoGeolocation(false);
	  }
}

function handleNoGeolocation(errorFlag) {
	if (errorFlag) {
		var content = 'Error: The Geolocation service failed.';
	} else {
		var content = 'Error: Your browser doesn\'t support geolocation.';
	}

	var options = {
		map: map,
		position: new google.maps.LatLng(60, 105),
		content: content
	};

	var infowindow = new google.maps.InfoWindow(options);
	map.setCenter(options.position);
}    
 
google.maps.event.addDomListener(window, 'load', initialize);
</script>